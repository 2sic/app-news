@using Connect.Koi;

@{
    var lib = CreateInstance("_library.cshtml"); 

    var catFilter = Request.QueryString["category"];
    var hasCategoryFilter = !String.IsNullOrEmpty(catFilter);
    var allCategories = AsDynamic(App.Data["Category"]);

    var newsPage = @Dnn.Tab.FullUrl;
    var newsPageTab = @Dnn.Module.TabID;
}
@if(!String.IsNullOrEmpty(Content.NewsPage)) 
{
    newsPage = Content.NewsPage;
    newsPageTab = int.Parse((AsEntity(Content).GetBestValue("NewsPage")).Split(':')[1]);
}
@if(Permissions.UserMayEditContent) {
    <div class="app-news-admin-menu">
        <div class="toolbar">
        	@Edit.Toolbar(actions: "new", contentType: "News", prefill: new { Date = DateTime.Now.Date, ShowFrom = DateTime.Now.Date, ShowTo =  (DateTime.Now.Date.AddYears(3)).Date }) <span style="font-size:14px; color:#666;">Neuen Newsbeitrag erstellen</span> &nbsp;&nbsp;&nbsp;
        	@Edit.Toolbar(toolbar: new object[] { 
                new { showCondition = true,
                    command = new { action = "contentitems", 
                        contentType = "News", 
                        filters = new { ModuleId = Dnn.Module.ModuleID } 
                    }
                }
            })<span style="font-size:14px;color:#666;">Newsbeitr√§ge verwalten</span>
              
        </div>
         <div>
             @Edit.Toolbar(Content)
        </div>
    </div>
}
<div class="app-news app-news-list sc-element" >
   
    <!--Category Filter == Displayed only if a category has been selected -->
        @if (hasCategoryFilter) {
            <div class="app-catinfo">
                <h2>@allCategories.Where(x => x.UrlKey == catFilter).FirstOrDefault().ShowedTitle</h2>
                <span><a @Koi.Class("bs3='btn btn-primary btn-xs' bs4,unk='btn btn-primary btn-sm'") href="@newsPage">@App.Resources.LabelCategoryAll</a></span>
                @foreach (var c in allCategories)
                {
                    <span><a @Koi.Class("all='" + (Request.QueryString["category"] == c.UrlKey ? "active" : "") + "' bs3='btn btn-primary btn-xs' bs4,unk='btn btn-primary btn-sm'") href="@lib.LinkToPage(newsPageTab, "category", c.UrlKey, "", "", "", "")">@c.Name</a></span>
                }
            </div>
        }
    <div @Koi.Class("all='row' bs3='autoclear' bs4,unk=''")>
      
        <!-- Beginning of content loop -->
        @foreach (var item in @AsDynamic(Data["News"]))
        {
        <div @Koi.Class("all='sc-element' bs3='col col-xs-12 col-sm-6 col-md-4 col-lg-4' bs4,unk='col col-12 col-md-6 col-lg-4 col-xl-4'")>
            @Edit.Toolbar(item)
            @{
                string detailsLink = @lib.LinkToPage(newsPageTab, "mid", ((String.IsNullOrEmpty(Content.MainModuleId)) ? (Dnn.Module.ModuleID).ToString() : (Content.MainModuleId)), "details", item.EntityId.ToString(), "title", item.UrlKey);
            }
            <div class="app-details-link">
                <a class="link-overlay" href="@detailsLink"></a>
                <!-- Image or Placeholder -->
                <div class="app-img-wrapper mb-3">
                     <!-- Image or Placeholder -->
                       
                         @if (!String.IsNullOrEmpty(@item.Image))
                        {
                           
                            <div class="app-img">
                                <span class="overlay"></span>
                                <img @Koi.Class("all='' bs3='img-responsive' bs4,oth='img-fluid'") src="@item.Image?w=800&h=480&mode=crop&scale=both&quality=80&anchor=@item.CropAnchor" alt="@item.Title" />
                            </div>
                          
                        }
                        else
                        {
                            <div class="app-img app-news-missing-img @((String.IsNullOrEmpty(@item.Image)) ? "app-noimg" : "")">
                                <span class="overlay" style="background-image: url(@App.Resources.PlaceholderMissingImage?max-width=600&amp;mode=max&amp;scale=both&amp;quality=80);"></span>
                                <img  @Koi.Class("bs3='img-responsive' bs4,unk='img-fluid'") src="@App.Path/res/trans.png?w=800&amp;h=480&amp;mode=crop&amp;scale=both&amp;quality=80" alt="" />
                            </div>
                        }
                </div>
                <!-- Text Date Categories -->
                <div class="app-text">
                    <h3>@item.Title</h3>
                   
                    <span class="app-date @((item.Categories.Count >  0 && App.Settings.ActivateCategories) ? "app-date-border" : "")">@item.Date.ToString("dd.MM.yyyy")</span>
                    <span class="app-categories">
                    @if(App.Settings.ActivateCategories) {
                        foreach (var cat in  @item.Categories)
                        {
                            <a href="@lib.LinkToPage(newsPageTab, "category", cat.UrlKey, "", "", "", "")">@cat.Name</a>
                        }
                    }
                    </span>
                  
                    <p>
                        @Html.Raw(item.Teaser.Replace("\n", "<br />"))
                    </p>
                </div>
                
                <span class="app-readmore">@Html.Raw(App.Resources.LabelReadMore)</span>
            </div>
            
                    
        </div>
        } <!-- END of content loop -->

    </div>
    @if (hasCategoryFilter) {
        <a @Koi.Class("all='app-backtolist' bs3='btn btn-primary' bs4,unk='btn btn-outline-primary'") href="@newsPage">@Html.Raw(App.Resources.LabelBackToList)</a>
    }

    @if (Content.ShowPagination) {
        @RenderPage("_paging.cshtml", new { newsPage = newsPage }) 
    }
</div>

<link rel="stylesheet" href="@App.Path/dist/@(Koi.PickCss("bs3,bs4", "bs3")).css" data-enableoptimizations="true" />
<script src="@App.Path/dist/script.js" data-enableoptimizations="true" ></script>
